# 이메일 레포트 기능 구현 문서

## 개요
웹 인터페이스를 통한 이메일 상담 보고서 생성 시 진행 상황과 결과를 이메일로 자동 발송하는 기능이 추가되었습니다.

## 주요 기능

### 1. 진행 시작 이메일 발송
웹 인터페이스를 통해 요청을 받으면 즉시 gmail_userid로 진행 시작 알림 이메일을 발송합니다.

**포함 정보:**
- 처리 기간 (시작일 ~ 종료일)
- 대상 이메일 수
- 예상 완료 시간 (이메일 1건당 2초로 계산)

**예시:**
```
제목: 이메일 상담 보고서 처리 시작

처리 정보:
• 기간: 2025-01-01 ~ 2025-01-31
• 대상 이메일 수: 50건
• 예상 완료 시간: 약 1분 40초

처리가 완료되면 결과를 이메일로 보내드리겠습니다.
```

### 2. 백그라운드 처리
- 웹 요청 후 즉시 응답을 반환하고 백그라운드 스레드에서 처리를 계속합니다
- 웹 브라우저를 닫아도 서버에서 처리가 계속 진행됩니다
- 처리 진행 상황은 Server-Sent Events (SSE)를 통해 실시간으로 확인 가능합니다

### 3. 완료 결과 이메일 발송
모든 처리가 완료되면 gmail_userid로 결과 이메일을 발송합니다.

**포함 정보:**
- 처리된 상담 기록 수
- 결과 요약 테이블 (HTML 형식)
- 상세 결과 엑셀 파일 (첨부)

**테이블 컬럼:**
- 번호
- 상담일
- 시작시간
- 종료시간
- 학생
- 학번
- 제목

## 기술 구현

### SMTP 이메일 발송
- Gmail SMTP 서버 (smtp.gmail.com:465) 사용
- SSL/TLS 암호화 연결
- gmail_userid와 gmail_password (앱 비밀번호) 사용

### 백그라운드 처리
- Python threading 모듈 사용
- daemon 스레드로 구현하여 메인 프로세스 종료 시 자동 종료
- 로그는 queue를 통해 웹 인터페이스로 스트리밍

### Excel 파일 첨부
- pandas와 openpyxl을 사용하여 Excel 파일 생성
- MIME multipart 메시지로 첨부
- Base64 인코딩으로 안전하게 전송
- 이메일 발송 후 서버에서 자동 삭제

## 사용 방법

### 웹 인터페이스 사용
1. http://localhost:5000 접속
2. Gmail 이메일 주소와 앱 비밀번호 입력
3. 처리할 기간 선택
4. "이메일 처리 시작" 버튼 클릭
5. 시작 알림 이메일 수신 확인
6. 진행 상황을 웹에서 실시간 확인 (선택사항)
7. 브라우저를 닫아도 처리는 계속됨
8. 완료 후 결과 이메일 수신

### 필수 설정
**Gmail 계정 설정:**
1. 2단계 인증 활성화
2. 앱 비밀번호 생성
3. IMAP 활성화

## API 변경사항

### `/process` 엔드포인트
**변경 전:**
- 동기 처리
- 완료될 때까지 대기
- 결과 데이터를 JSON으로 반환

**변경 후:**
- 비동기 처리 (백그라운드 스레드)
- 즉시 응답 반환
- 결과는 이메일로 발송

**응답 형식:**
```json
{
  "success": true,
  "message": "처리가 시작되었습니다. 총 50개의 이메일을 처리합니다.",
  "email_count": 50,
  "background": true
}
```

## 함수 설명

### `send_email_via_smtp()`
Gmail SMTP를 통해 이메일을 발송하는 핵심 함수입니다.

**파라미터:**
- `gmail_userid`: 발신 Gmail 계정
- `gmail_password`: Gmail 앱 비밀번호
- `to_email`: 수신 이메일 주소
- `subject`: 이메일 제목
- `body`: 이메일 본문 (HTML 지원)
- `attachment_path`: 첨부 파일 경로 (선택사항)

### `send_start_notification()`
처리 시작 알림 이메일을 발송합니다.

**파라미터:**
- `gmail_userid`: Gmail 계정
- `gmail_password`: Gmail 앱 비밀번호
- `start_date`: 시작일 문자열
- `end_date`: 종료일 문자열
- `email_count`: 처리할 이메일 수

### `send_completion_notification()`
처리 완료 알림 이메일을 발송합니다.

**파라미터:**
- `gmail_userid`: Gmail 계정
- `gmail_password`: Gmail 앱 비밀번호
- `pairs`: 처리된 이메일 쌍 리스트
- `excel_path`: Excel 파일 경로

### `process_emails_background()`
백그라운드에서 이메일 처리를 수행합니다.

**주요 동작:**
1. 이메일 수집 및 필터링
2. Excel 파일 생성
3. 완료 이메일 발송
4. 임시 파일 정리

## 보안 고려사항

1. **Gmail 앱 비밀번호 사용**: 일반 비밀번호가 아닌 앱 비밀번호를 사용하여 보안 강화
2. **SSL/TLS 암호화**: 모든 SMTP 통신은 SSL/TLS로 암호화됨
3. **임시 파일 삭제**: Excel 파일을 이메일 발송 후 즉시 삭제
4. **환경 변수**: 민감한 정보는 환경 변수로 관리 권장

## 에러 처리

### 이메일 발송 실패
- 로그에 에러 메시지 기록
- 처리는 계속 진행 (이메일 발송 실패가 전체 프로세스를 중단하지 않음)

### 인증 실패
- 사용자에게 명확한 에러 메시지 표시
- Gmail 앱 비밀번호 설정 안내 제공

### 백그라운드 처리 에러
- 로그 큐를 통해 에러 메시지 전달
- 웹 인터페이스에서 실시간 확인 가능

## 테스트

테스트 스크립트가 제공됩니다:
- `/tmp/test_email_functions.py`: 이메일 구성 기능 테스트
- `/tmp/test_background_processing.py`: 백그라운드 처리 컴포넌트 테스트

실행:
```bash
python3 /tmp/test_email_functions.py
python3 /tmp/test_background_processing.py
```

## 향후 개선 가능 사항

1. **이메일 템플릿**: 더 풍부한 HTML 템플릿 사용
2. **진행률 이메일**: 처리 중간에 진행률 업데이트 이메일 발송
3. **에러 알림**: 처리 실패 시 에러 내용을 이메일로 발송
4. **다중 수신자**: 여러 이메일 주소로 결과 발송
5. **이메일 큐**: 대량 이메일 발송 시 큐 시스템 도입
